<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Assistant Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for the chat window */
        #chat-window::-webkit-scrollbar {
            width: 8px;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background-color: #93c5fd; /* Light Blue/Cyan */
            border-radius: 4px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #eef2ff; /* Very light background */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased h-screen flex justify-center items-center p-4">

    <!-- Main Chat Container -->
    <div class="flex flex-col bg-white shadow-2xl rounded-xl w-full max-w-lg h-full max-h-[90vh] overflow-hidden">
        
        <!-- Header -->
        <header class="flex items-center justify-between p-4 bg-blue-700 text-white rounded-t-xl shadow-lg flex-shrink-0">
            <h1 class="text-xl font-bold flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                AI Health Assistant
            </h1>
            <span class="text-sm font-light opacity-80">Fast Text-Only Project | [Your Name]</span>
        </header>

        <!-- Mandatory Disclaimer -->
        <div id="disclaimer" class="p-3 bg-orange-200 text-orange-800 text-xs font-medium border-l-4 border-orange-500 flex-shrink-0">
            <span class="font-bold">MANDATORY WARNING:</span> This tool uses AI and is for informational purposes only. It is **NOT** a substitute for professional medical advice, diagnosis, or treatment. Always consult a qualified doctor.
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-50">
            <!-- Initial AI Message -->
            <div class="flex justify-start">
                <div class="max-w-[85%] bg-blue-50 text-blue-900 p-3 rounded-xl rounded-tl-none shadow-md border border-blue-200">
                    <p class="font-medium">Hello! I am an **AI Health Assistant** powered by Groq.</p>
                    <p class="mt-1">I can provide fast, concise facts on health topics. ***How may I assist you today?***</p>
                    <p class="mt-2 text-xs italic text-blue-700">**Remember: I am not a doctor.** Please start by asking a general health question (e.g., "What are common symptoms of seasonal allergies?" or "What are the benefits of walking?").</p>
                </div>
            </div>
            <!-- Messages will be injected here by JavaScript -->
        </div>

        <!-- Input Form -->
        <form id="chat-form" class="flex p-4 bg-white border-t border-gray-200 flex-shrink-0">
            <input 
                type="text" 
                id="user-input" 
                placeholder="Ask a health question..." 
                class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:border-blue-500 transition duration-150 shadow-inner" 
                required
            />
            <button 
                type="submit" 
                id="send-button"
                class="ml-3 p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.183.189l4.577-3.66a1 1 0 01.98-.016l3.52 1.879 2.518-2.518-2.433-4.866a1 1 0 00-.73-1.025l-2.92-.73z" />
                </svg>
            </button>
        </form>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // IMPORTANT FIX: Updated API path to Netlify Functions convention
        const apiUrl = '/.netlify/functions/chat'; 

        // Utility to escape HTML for safe insertion (not strictly needed here, but good practice)
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        // Add a new message bubble to the chat window
        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', 'p-1');
            
            let bubbleClasses, textContent;
            
            if (sender === 'user') {
                messageElement.classList.add('justify-end');
                bubbleClasses = 'max-w-[85%] bg-blue-600 text-white p-3 rounded-xl rounded-br-none shadow-md';
                textContent = escapeHTML(text);
            } else { // 'ai' or 'error'
                messageElement.classList.add('justify-start');
                
                if (text.includes("Error:") || sender === 'error') {
                    // Specific styling for the API failed message
                    bubbleClasses = 'max-w-[85%] bg-red-100 text-red-800 p-3 rounded-xl rounded-tl-none shadow-md border border-red-300';
                    textContent = text; // Error text might already contain formatting
                } else {
                    // Standard AI response styling
                    bubbleClasses = 'max-w-[85%] bg-blue-50 text-blue-900 p-3 rounded-xl rounded-tl-none shadow-md border border-blue-200';
                    textContent = formatMarkdown(text);
                }
            }

            messageElement.innerHTML = `<div class="${bubbleClasses}">${textContent}</div>`;
            chatWindow.appendChild(messageElement);
            
            // Scroll to the bottom of the chat window
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Simple markdown formatter for AI responses
        function formatMarkdown(text) {
            // Bold (**text** to <b>text</b>)
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italics (*text* or _text_ to <i>text</i>)
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/_(.*?)_/g, '<em>$1</em>');
            // New lines (\n to <br>)
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        // Add a loading indicator (dots)
        function addLoadingIndicator() {
            const loadingElement = document.createElement('div');
            loadingElement.id = 'loading-indicator';
            loadingElement.classList.add('flex', 'justify-start', 'p-1');
            loadingElement.innerHTML = `
                <div class="max-w-[85%] bg-blue-50 text-blue-900 p-3 rounded-xl rounded-tl-none shadow-md border border-blue-200">
                    <span class="loader">...</span>
                </div>
            `;
            chatWindow.appendChild(loadingElement);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
            return loadingElement;
        }

        // Remove the loading indicator
        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Exponential backoff retry logic for API calls
        async function fetchWithRetry(url, options, maxRetries = 3, delay = 500) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 429) { // Too Many Requests (Rate Limit)
                        // Wait longer if rate limited
                        await new Promise(resolve => setTimeout(resolve, delay * 2));
                    } else {
                        // For other non-OK status codes (400, 500, etc.), throw an error immediately
                        const errorData = await response.json().catch(() => ({ message: 'Unknown server error' }));
                        throw new Error(`API returned status ${response.status}: ${errorData.message}`);
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) {
                        throw new Error("API failed after multiple retries.");
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1))); // Exponential delay
                }
            }
        }


        async function handleSubmit(event) {
            event.preventDefault();
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // 1. Display user message
            addMessage(prompt, 'user');
            userInput.value = ''; // Clear input field

            // 2. Disable input and show loading
            sendButton.disabled = true;
            userInput.disabled = true;
            const loadingIndicator = addLoadingIndicator();

            const systemInstruction = {
                parts: [{ text: "You are a professional, helpful, and concise AI Health Assistant. You must always include a disclaimer: 'Disclaimer: I am an AI assistant, not a doctor.' at the start of every response. Your responses should be factual and never advise on specific medical treatments or diagnoses." }]
            };

            const payload = { prompt, systemInstruction };

            try {
                // 3. Make the API call with retry logic
                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, 3); // Max 3 retries

                // 4. Handle success response
                removeLoadingIndicator();
                if (result && result.text) {
                    addMessage(result.text, 'ai');
                } else {
                    addMessage('Disclaimer: I am an AI assistant, not a doctor. I was unable to retrieve a response (empty data).', 'error');
                }

            } catch (error) {
                // 5. Handle error response
                removeLoadingIndicator();
                console.error("Fetch failed:", error);
                
                // Display the specific error message caught by the retry logic
                addMessage(`Disclaimer: I am an AI assistant, not a doctor. I am sorry, but I was unable to retrieve a response at this time. (Error: ${error.message})`, 'error');

            } finally {
                // 6. Re-enable input
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        chatForm.addEventListener('submit', handleSubmit);
    </script>
</body>
</html>
