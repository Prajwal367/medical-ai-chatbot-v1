<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        body { font-family: 'Inter', sans-serif; }
        
        /* Ensure the body fills the entire viewport and stacks elements */
        .app-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            height: 100vh; /* Set explicit height for better flex behavior */
            overflow-y: hidden; /* Prevent body scroll */
        }

        /* Styling for the main chat window area */
        #chat-window {
            flex-grow: 1; /* Allows the chat area to fill available space */
            overflow-y: auto; /* ENSURES vertical scrolling within the chat */
            padding: 1.5rem;
            max-width: 1000px; /* Optional: Limit width on large screens */
            width: 100%;
            margin: 0 auto;
        }

        /* Blue chat bubble (User) */
        .user-bubble {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            border-radius: 1rem 0.5rem 0.5rem 1rem;
            max-width: 60%;
            margin-left: auto;
        }

        /* Light blue chat bubble (Assistant/Result) */
        .assistant-bubble {
            background-color: #eff6ff; /* Tailwind blue-50 */
            color: #1f2937; /* Tailwind gray-800 */
            border-radius: 0.5rem 1rem 1rem 0.5rem;
            max-width: 75%;
            margin-right: auto;
            border: 1px solid #bfdbfe; /* Tailwind blue-200 */
        }
        
        /* Keep header and footer height stable for scrolling calculation */
        header, #input-footer {
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-gray-100 app-layout">

    <!-- 1. Header (Top Blue Banner) -->
    <header class="bg-blue-800 text-white p-4 shadow-md flex justify-center sticky top-0 z-10">
        <div class="w-full max-w-4xl flex justify-between items-center">
            <h1 class="text-xl font-bold">HEALTH ASSISTANT</h1>
            <span class="text-sm font-medium opacity-80">Fact Finder Project</span>
        </div>
    </header>

    <!-- 2. Mandatory Warning Disclaimer (Yellow Banner) -->
    <div class="bg-yellow-100 text-yellow-800 text-sm font-medium p-3 flex justify-center w-full shadow-inner sticky top-16 z-10">
        <div class="w-full max-w-4xl">
            <strong class="uppercase mr-2">Mandatory Warning:</strong> This tool uses Wikipedia and is for informational purposes only. It is **NOT** a substitute for professional medical advice, diagnosis, or treatment. Always consult a qualified doctor.
        </div>
    </div>

    <!-- 3. Chat Window (Scrollable Content Area) -->
    <div id="chat-window" class="space-y-6 pt-6 pb-6">
        
        <!-- ASSISTANT: Initial Welcome Message -->
        <div class="flex justify-start">
            <div class="assistant-bubble p-4 shadow-lg">
                <p class="font-bold text-lg text-blue-800 mb-2">Hello! I am a **Wikipedia Health Assistant**.</p>
                <p>I can provide quick, sourced summaries from Wikipedia. ***What health topic would you like to search for?***</p>
                <p class="text-xs mt-2 text-gray-500">Please start by asking a general health question (e.g., "seasonal allergies," "benefits of walking," or "what is an aneurysm?").</p>
            </div>
        </div>
        
    </div>

    <!-- 4. Input Footer (Fixed Bottom Bar) -->
    <div id="input-footer" class="bg-white p-4 border-t border-gray-200 sticky bottom-0 z-20 flex justify-center w-full">
        <div class="w-full max-w-4xl flex gap-3">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search for a health topic..." 
                class="flex-grow p-3 border-2 border-gray-300 rounded-full focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-base shadow-inner"
                onkeydown="if(event.key === 'Enter') handleUserInput()"
            >
            <button 
                id="searchButton" 
                onclick="handleUserInput()" 
                class="bg-blue-600 text-white w-12 h-12 rounded-full font-bold hover:bg-blue-700 transition duration-200 shadow-xl active:scale-95 transform flex items-center justify-center"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" transform="rotate(90 12 12) translate(0 0) scale(-1 1)" />
                </svg>
            </button>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        // NOTE: The 'Api-User-Agent' is mandatory for Wikipedia requests
        const WIKI_USER_AGENT = 'HealthAssistantApp/1.8 (user-provided-email.com)'; 
        const WIKI_API_URL = 'https://en.wikipedia.org/w/api.php';
        const chatWindow = document.getElementById('chat-window');
        const searchInput = document.getElementById('searchInput');
        const GREETINGS = ['hi', 'hello', 'hey', 'good morning', 'good afternoon'];
        // Increased max length for a more detailed, readable paragraph
        const MAX_SUMMARY_LENGTH = 350; 
        
        // Expanded list for better, more accurate medical filtering
        const MEDICAL_KEYWORDS = [
            'disease', 'syndrome', 'disorder', 'condition', 'treatment', 'therapy', 'drug',
            'medicine', 'anatomy', 'physiology', 'surgery', 'virus', 'bacteria', 'fungus',
            'medical', 'health', 'symptom', 'pain', 'cold', 'flu', 
            'diabetes', 'complication', 'nutrition', 'vaccine', 'virus',
            'heart', 'kidney', 'lung', 'infection', 'inflammation',
            'fever', 'cough', 'cancer', 'headache', 'allergy', 'aneurysm', 'migraine', 
            'asthma', 'insomnia', 'anxiety', 'depression', 'hypertension', 'stroke',
            'dermatology', 'cardiology', 'gastroenterology', 'neurology', 'pediatrics'
        ];


        /**
         * Utility function to scroll the chat window to the bottom.
         */
        function scrollToBottom() {
            // Use a slight timeout to ensure DOM updates complete before scrolling
            setTimeout(() => {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 50);
        }

        /**
         * Adds a message bubble to the chat window.
         * @param {string} content - The HTML content to display inside the bubble.
         * @param {string} type - 'user' or 'assistant'.
         */
        function addMessage(content, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `${type === 'user' ? 'user-bubble' : 'assistant-bubble'} p-4 shadow-md`;
            bubble.innerHTML = content;
            
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            scrollToBottom();
            return bubble; // Return the bubble element for later updates (e.g., loading state)
        }
        
        /**
         * Responds to common greetings.
         * @param {string} query The user's input.
         * @returns {boolean} True if a greeting was handled, false otherwise.
         */
        function handleGreeting(query) {
            const normalizedQuery = query.toLowerCase();
            
            // Check if the query starts with or is exactly a greeting
            const isGreeting = GREETINGS.some(greeting => 
                normalizedQuery === greeting || normalizedQuery.startsWith(greeting + ' ')
            );

            if (isGreeting) {
                const response = `
                    <p class="font-bold text-lg text-blue-800 mb-2">Hello! How can I assist you with your health query today?</p>
                    <p class="text-gray-700 leading-relaxed">Remember, I use Wikipedia for information. For example, try asking: "What are the common symptoms of influenza?"</p>
                `;
                addMessage(response, 'assistant');
                return true;
            }
            return false;
        }

        /**
         * Extracts the main topic keyword from a question or sentence.
         * @param {string} query The raw user input.
         * @returns {string} The cleaned search term.
         */
        function extractSearchTerm(query) {
            // 1. Convert to lowercase and trim
            let lowerQuery = query.toLowerCase().trim();

            // 2. Remove common question prefixes and punctuation
            lowerQuery = lowerQuery
                .replace(/^(what are the common symptoms of|what is|tell me about|i have|what causes|how do i treat|symptoms of|causes of|how to treat)\s+/i, '')
                .replace(/[?,.!'"]+/g, '');

            // 3. Return the remaining simplified term
            return lowerQuery.trim();
        }

        /**
         * Checks if the article title is likely medical based on defined keywords.
         * @param {string} title The title of the Wikipedia article.
         * @param {string} cleanedQuery The simplified search term.
         * @returns {boolean} True if the topic is highly likely to be medical.
         */
        function isMedicalTopic(title, cleanedQuery) {
            const normalizedTitle = title.toLowerCase();
            const normalizedCleanedQuery = cleanedQuery.toLowerCase();
            
            // Check if the title contains any strong medical keyword
            const titleContainsMedicalKeyword = MEDICAL_KEYWORDS.some(keyword => normalizedTitle.includes(keyword.toLowerCase()));

            // Check if the cleaned search query itself is one of the recognized medical terms
            const isBasicMedicalTerm = MEDICAL_KEYWORDS.includes(normalizedCleanedQuery);

            // Check if the simplified query is directly contained in the title
            const titleContainsQuery = normalizedTitle.includes(normalizedCleanedQuery);

            // A match is highly relevant if the title contains the query OR contains a strong medical keyword OR the query itself is a medical term
            return titleContainsQuery || titleContainsMedicalKeyword || isBasicMedicalTerm;
        }


        /**
         * Simplifies and shortens the Wikipedia extract.
         * @param {string} extract The raw text extract from the API.
         * @returns {string} The simplified, shortened, plain text summary.
         */
        function createSimpleSummary(extract) {
            // 1. Remove all HTML tags and entities
            let plainText = extract.replace(/<[^>]*>/g, '').replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');

            // 2. Aggressively remove common introductory Wikipedia phrases/formatting
            plainText = plainText
                .replace(/\(.*?\)/g, '') // Remove parenthetical definitions (e.g., (flu))
                .replace(/^(is a symptom of|is a condition where|is a type of|is an inflammatory process|also known as)/i, '')
                .trim();

            // 3. Limit length
            if (plainText.length > MAX_SUMMARY_LENGTH) {
                // Find the last sentence-ending punctuation before the limit
                let truncated = plainText.substring(0, MAX_SUMMARY_LENGTH);
                let lastPunctuation = Math.max(
                    truncated.lastIndexOf('.'), 
                    truncated.lastIndexOf('?'), 
                    truncated.lastIndexOf('!')
                );
                
                if (lastPunctuation !== -1 && lastPunctuation > MAX_SUMMARY_LENGTH * 0.8) {
                    // If punctuation is near the end, cut there
                    plainText = truncated.substring(0, lastPunctuation + 1);
                } else {
                    // Fallback to word cutoff
                    let lastSpace = truncated.lastIndexOf(' ');
                    plainText = (lastSpace !== -1 ? truncated.substring(0, lastSpace) : truncated) + '...';
                }
            }

            // 4. Ensure it starts with a capital letter
            if (plainText.length > 0) {
                plainText = plainText.charAt(0).toUpperCase() + plainText.slice(1);
            }

            return plainText;
        }


        /**
         * Handles user input: adds user bubble and starts the search or handles a greeting.
         */
        function handleUserInput() {
            const query = searchInput.value.trim();
            if (!query) return;

            // 1. Add user's message bubble
            addMessage(query, 'user');
            
            // 2. Clear input and disable for loading
            searchInput.value = '';
            searchInput.disabled = true;
            document.getElementById('searchButton').disabled = true;

            // 3. Handle Greeting
            if (handleGreeting(query)) {
                // Re-enable input if greeting was handled
                searchInput.disabled = false;
                document.getElementById('searchButton').disabled = false;
                searchInput.focus();
                return;
            }

            // 4. Extract the core search term from the query
            const searchTerm = extractSearchTerm(query);

            // 5. Start search
            searchWikipedia(query, searchTerm);
        }
        
        /**
         * Performs the search against the Wikipedia API in two steps: search for title, then fetch extract.
         * @param {string} originalQuery The full user input.
         * @param {string} searchTerm The simplified term used for the actual search.
         */
        async function searchWikipedia(originalQuery, searchTerm) {
            
            // Temporary loading message
            const loadingHtml = `
                <div class="flex items-center space-x-2 text-gray-500">
                    <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Searching Wikipedia for **"${searchTerm}"**...</span>
                </div>
            `;
            const loadingBubble = addMessage(loadingHtml, 'assistant');

            try {
                // --- STEP 1: Search for the best matching article title ---
                const searchTerms = `intitle:"${searchTerm}" OR ${searchTerm} category:Health OR category:Medicine OR category:Diseases`;
                
                const searchParams = new URLSearchParams({
                    action: 'query',
                    list: 'search',
                    srsearch: searchTerms, 
                    srlimit: 1, 
                    format: 'json',
                    origin: '*' 
                });

                const searchUrl = `${WIKI_API_URL}?${searchParams.toString()}`;
                
                // Fetch 1: Search for Title
                let searchResponse = await fetch(searchUrl, {
                    method: 'GET',
                    headers: { 'Api-User-Agent': WIKI_USER_AGENT }
                });

                if (!searchResponse.ok) {
                    throw new Error(`HTTP error during search! status: ${searchResponse.status}`);
                }
                let searchData = await searchResponse.json();
                
                const searchResults = searchData.query?.search;
                
                let resultHtml;

                if (searchResults && searchResults.length > 0) {
                    const result = searchResults[0]; 
                    
                    // --- STEP 1.1: SMART MEDICAL FILTER ---
                    if (!isMedicalTopic(result.title, searchTerm)) {
                         resultHtml = `
                            <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Topic Blocked</p>
                            <p class="font-bold text-lg text-red-700 mb-2">Non-Medical Query Detected</p>
                            <p class="text-gray-700">The query **"${originalQuery}"** did not return a strongly medical or health-related Wikipedia article (found: "${result.title}").</p>
                            <p class="text-gray-700 mt-2">This Health Assistant is restricted to providing information only on medical and health topics.</p>
                        `;
                    } else {
                        // --- STEP 2: Fetch the full, initial extract of the article ---
                        const extractParams = new URLSearchParams({
                            action: 'query',
                            prop: 'extracts',
                            titles: result.title,
                            exintro: true, // Only return the content before the first section
                            explaintext: true, // Return plain text, not HTML
                            format: 'json',
                            origin: '*'
                        });

                        const extractUrl = `${WIKI_API_URL}?${extractParams.toString()}`;
                        
                        // Fetch 2: Get Article Extract
                        let extractResponse = await fetch(extractUrl, {
                            method: 'GET',
                            headers: { 'Api-User-Agent': WIKI_USER_AGENT }
                        });
                        
                        let extractData = await extractResponse.json();

                        const pages = extractData.query.pages;
                        const pageId = Object.keys(pages)[0];
                        const extract = pages[pageId]?.extract; // Use optional chaining for safety

                        if (extract) {
                             // --- STEP 3: DISPLAY VALID MEDICAL RESULT (Simplified and Longer) ---
                            const simpleSummary = createSimpleSummary(extract);
                            const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(result.title.replace(/ /g, '_'))}`;

                            resultHtml = `
                                <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Disclaimer: I am a fact-finding assistant, not a doctor.</p>
                                <h4 class="font-bold text-lg text-blue-700 mb-2">Quick Summary for "${result.title}"</h4>
                                <p class="text-gray-800 leading-relaxed font-medium">${simpleSummary}</p>
                                <p class="mt-3 text-xs">Source: <a href="${wikiUrl}" target="_blank" class="text-teal-600 hover:underline">Read the full Wikipedia article for more detail</a></p>
                            `;
                        } else {
                            // If extract fails but the title was found
                            const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(result.title.replace(/ /g, '_'))}`;
                            resultHtml = `
                                <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Disclaimer: I am a fact-finding assistant, not a doctor.</p>
                                <p class="font-bold text-lg text-red-700 mb-2">Could Not Load Article Details</p>
                                <p class="text-gray-700">We found the article: **"${result.title}"**, but could not retrieve the text summary. Please try again or click the link below to view it directly.</p>
                                <p class="mt-3 text-xs">Source: <a href="${wikiUrl}" target="_blank" class="text-teal-600 hover:underline">View Article</a></p>
                            `;
                        }
                    }
                } else {
                    // --- STEP 4: NO RESULT FOUND ---
                    resultHtml = `
                        <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Disclaimer: I am a fact-finding assistant, not a doctor.</p>
                        <p class="font-bold text-lg text-blue-700 mb-2">No Wikipedia Result</p>
                        <p class="text-gray-700">No specific health article found for your query: **"${originalQuery}"**. Please try a different term or simplify your question.</p>
                    `;
                }
                
                // Replace loading bubble content with results
                loadingBubble.innerHTML = resultHtml;

            } catch (error) {
                console.error('Wikipedia API Error:', error);
                
                // Replace loading bubble content with error message
                loadingBubble.innerHTML = `
                    <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">System Error</p>
                    <p class="text-red-700">An unexpected error occurred while connecting to the source. Error details logged to console. Please try your search again.</p>
                `;
            } finally {
                // Re-enable input
                searchInput.disabled = false;
                document.getElementById('searchButton').disabled = false;
                searchInput.focus();
                scrollToBottom();
            }
        }
    </script>
</body>
</html>
