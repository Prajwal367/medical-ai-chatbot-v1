<!DOCTYPE ahtml>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        body { font-family: 'Inter', sans-serif; }
        
        /* Ensure the body fills the entire viewport and stacks elements */
        .app-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            height: 100vh; /* Set explicit height for better flex behavior */
            overflow-y: hidden; /* Prevent body scroll */
        }

        /* Styling for the main chat window area */
        #chat-window {
            flex-grow: 1; /* Allows the chat area to fill available space */
            overflow-y: auto; /* ENSURES vertical scrolling within the chat */
            padding: 1.5rem;
            max-width: 1000px; /* Optional: Limit width on large screens */
            width: 100%;
            margin: 0 auto;
        }

        /* Blue chat bubble (User) */
        .user-bubble {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            border-radius: 1rem 0.5rem 0.5rem 1rem;
            max-width: 60%;
            margin-left: auto;
        }

        /* Light blue chat bubble (Assistant/Result) */
        .assistant-bubble {
            background-color: #eff6ff; /* Tailwind blue-50 */
            color: #1f2937; /* Tailwind gray-800 */
            border-radius: 0.5rem 1rem 1rem 0.5rem;
            max-width: 75%;
            margin-right: auto;
            border: 1px solid #bfdbfe; /* Tailwind blue-200 */
        }
        
        /* Keep header and footer height stable for scrolling calculation */
        header, #input-footer {
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-gray-100 app-layout">

    <!-- 1. Header (Top Blue Banner) -->
    <header class="bg-blue-800 text-white p-4 shadow-md flex justify-center sticky top-0 z-10">
        <div class="w-full max-w-4xl flex justify-between items-center">
            <h1 class="text-xl font-bold">HEALTH ASSISTANT</h1>
            <span class="text-sm font-medium opacity-80">Fact Finder Project</span>
        </div>
    </header>

    <!-- 2. Mandatory Warning Disclaimer (Yellow Banner) -->
    <div class="bg-yellow-100 text-yellow-800 text-sm font-medium p-3 flex justify-center w-full shadow-inner sticky top-16 z-10">
        <div class="w-full max-w-4xl">
            <strong class="uppercase mr-2">Mandatory Warning:</strong> This tool uses Wikipedia and is for informational purposes only. It is **NOT** a substitute for professional medical advice, diagnosis, or treatment. Always consult a qualified doctor.
        </div>
    </div>

    <!-- 3. Chat Window (Scrollable Content Area) -->
    <!-- The padding-bottom pb-24 ensures space above the fixed footer -->
    <div id="chat-window" class="space-y-6 pt-6 pb-6">
        
        <!-- ASSISTANT: Initial Welcome Message -->
        <div class="flex justify-start">
            <div class="assistant-bubble p-4 shadow-lg">
                <p class="font-bold text-lg text-blue-800 mb-2">Hello! I am a **Wikipedia Health Assistant**.</p>
                <p>I can provide quick, sourced summaries from Wikipedia. ***What health topic would you like to search for?***</p>
                <p class="text-xs mt-2 text-gray-500">Please start by asking a general health question (e.g., "seasonal allergies," "benefits of walking," or "what is an aneurysm?").</p>
            </div>
        </div>
        
    </div>

    <!-- 4. Input Footer (Fixed Bottom Bar) -->
    <div id="input-footer" class="bg-white p-4 border-t border-gray-200 sticky bottom-0 z-20 flex justify-center w-full">
        <div class="w-full max-w-4xl flex gap-3">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search for a health topic..." 
                class="flex-grow p-3 border-2 border-gray-300 rounded-full focus:ring-teal-500 focus:border-teal-500 transition duration-200 text-base shadow-inner"
                onkeydown="if(event.key === 'Enter') handleUserInput()"
            >
            <button 
                id="searchButton" 
                onclick="handleUserInput()" 
                class="bg-blue-600 text-white w-12 h-12 rounded-full font-bold hover:bg-blue-700 transition duration-200 shadow-xl active:scale-95 transform flex items-center justify-center"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" transform="rotate(90 12 12) translate(0 0) scale(-1 1)" />
                </svg>
            </button>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const WIKI_USER_AGENT = 'HealthAssistantApp/1.5 (contact@user-provided-email.com)';
        const WIKI_API_URL = 'https://en.wikipedia.org/w/api.php';
        const chatWindow = document.getElementById('chat-window');
        const searchInput = document.getElementById('searchInput');
        const GREETINGS = ['hi', 'hello', 'hey', 'good morning', 'good afternoon'];
        
        // Keywords that MUST be present in the title for it to be considered medical
        const MEDICAL_KEYWORDS = [
            'disease', 'syndrome', 'disorder', 'condition', 'treatment', 'therapy', 'drug',
            'medicine', 'anatomy', 'physiology', 'surgery', 'virus', 'bacteria', 'fungus',
            'medical', 'health', 'symptom', 'pain', 'cold', 'flu', 
            'diabetes', 'complication', 'nutrition', 'vaccine', 'virus',
            'heart', 'kidney', 'lung', 'infection', 'inflammation',
            // Explicitly include basic terms that often have specific Wikipedia pages
            'fever', 'cough', 'cancer', 'headache' 
        ];


        /**
         * Utility function to scroll the chat window to the bottom.
         */
        function scrollToBottom() {
            // Use a slight timeout to ensure DOM updates complete before scrolling
            setTimeout(() => {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 50);
        }

        /**
         * Adds a message bubble to the chat window.
         * @param {string} content - The HTML content to display inside the bubble.
         * @param {string} type - 'user' or 'assistant'.
         */
        function addMessage(content, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `${type === 'user' ? 'user-bubble' : 'assistant-bubble'} p-4 shadow-md`;
            bubble.innerHTML = content;
            
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            scrollToBottom();
            return bubble; // Return the bubble element for later updates (e.g., loading state)
        }
        
        /**
         * Responds to common greetings.
         * @param {string} query The user's input.
         * @returns {boolean} True if a greeting was handled, false otherwise.
         */
        function handleGreeting(query) {
            const normalizedQuery = query.toLowerCase();
            
            // Check if the query starts with or is exactly a greeting
            const isGreeting = GREETINGS.some(greeting => 
                normalizedQuery === greeting || normalizedQuery.startsWith(greeting + ' ')
            );

            if (isGreeting) {
                const response = `
                    <p class="font-bold text-lg text-blue-800 mb-2">Hello! How can I assist you with your health query today?</p>
                    <p class="text-gray-700 leading-relaxed">Remember, I use Wikipedia for information. For example, try asking: "What are the common symptoms of influenza?"</p>
                `;
                addMessage(response, 'assistant');
                return true;
            }
            return false;
        }

        /**
         * Extracts the main topic keyword from a question or sentence.
         * Example: "What are the common symptoms of influenza?" -> "influenza"
         * @param {string} query The raw user input.
         * @returns {string} The cleaned search term.
         */
        function extractSearchTerm(query) {
            // 1. Convert to lowercase and trim
            let lowerQuery = query.toLowerCase().trim();

            // 2. Remove common question prefixes and punctuation
            lowerQuery = lowerQuery
                .replace(/^(what are the common symptoms of|what is|tell me about|i have|what causes|how do i treat)\s+/i, '')
                .replace(/[?,.!'"]+/g, '');

            // 3. Return the remaining simplified term
            return lowerQuery.trim();
        }

        /**
         * Checks if the article title is likely medical based on defined keywords.
         * We check the title AND the cleaned search term here for better flexibility.
         * @param {string} title The title of the Wikipedia article.
         * @param {string} cleanedQuery The simplified search term (e.g., "influenza").
         * @returns {boolean} True if the topic is highly likely to be medical.
         */
        function isMedicalTopic(title, cleanedQuery) {
            const normalizedTitle = title.toLowerCase();
            
            // Check if the title contains any strong medical keyword
            const titleContainsMedicalKeyword = MEDICAL_KEYWORDS.some(keyword => normalizedTitle.includes(keyword.toLowerCase()));

            // Check if the cleaned search query itself is a basic, recognized medical term 
            const isBasicMedicalTerm = ['fever', 'cough', 'cancer', 'headache', 'flu', 'diabetes', 'asthma'].includes(cleanedQuery.toLowerCase());

            // Check if the result title is a direct match for the basic term OR
            // if the title is clearly related to medicine (e.g., "Fred Hutchinson Cancer Center" passes because it contains "cancer").
            const isHighlyRelevantMatch = titleContainsMedicalKeyword || normalizedTitle.includes(cleanedQuery.toLowerCase()) || isBasicMedicalTerm;

            return isHighlyRelevantMatch;
        }


        /**
         * Handles user input: adds user bubble and starts the search or handles a greeting.
         */
        function handleUserInput() {
            const query = searchInput.value.trim();
            if (!query) return;

            // 1. Add user's message bubble
            addMessage(query, 'user');
            
            // 2. Clear input and disable for loading
            searchInput.value = '';
            searchInput.disabled = true;
            document.getElementById('searchButton').disabled = true;

            // 3. Handle Greeting
            if (handleGreeting(query)) {
                 // Re-enable input if greeting was handled
                searchInput.disabled = false;
                document.getElementById('searchButton').disabled = false;
                searchInput.focus();
                return;
            }

            // 4. Extract the core search term from the query
            const searchTerm = extractSearchTerm(query);

            // 5. Start search
            searchWikipedia(query, searchTerm);
        }

        /**
         * Cleans the snippet, applying basic filtering and highlighting.
         * @param {string} snippet The raw HTML snippet from the API.
         * @returns {string} Cleaned HTML string.
         */
        const cleanSnippet = (snippet) => {
            // Highlight search matches with a prominent color
            let cleaned = snippet
                .replace(/<span class="searchmatch">/g, '<strong class="text-teal-700 font-semibold">')
                .replace(/<\/span>/g, '</strong>');
            return cleaned;
        };
        
        /**
         * Performs the search against the Wikipedia API and displays the result as an assistant message.
         * @param {string} originalQuery The full user input.
         * @param {string} searchTerm The simplified term used for the actual search.
         */
        async function searchWikipedia(originalQuery, searchTerm) {
            
            // Temporary loading message
            const loadingHtml = `
                <div class="flex items-center space-x-2 text-gray-500">
                    <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Searching for **"${searchTerm}"**...</span>
                </div>
            `;
            const loadingBubble = addMessage(loadingHtml, 'assistant');

            // Search for the exact title first using "intitle" and also include broad medical categories as a fallback.
            const searchTerms = `intitle:"${searchTerm}" OR ${searchTerm} category:Health OR category:Medicine OR category:Diseases`;
            
            const params = new URLSearchParams({
                action: 'query',
                list: 'search',
                srsearch: searchTerms, 
                srlimit: 1, 
                srwhat: 'text', 
                format: 'json',
                origin: '*' 
            });

            try {
                const apiUrlWithParams = `${WIKI_API_URL}?${params.toString()}`;

                const response = await fetch(apiUrlWithParams, {
                    method: 'GET',
                    headers: { 'Api-User-Agent': WIKI_USER_AGENT }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Received non-JSON response from API.");
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`Wikipedia API Error: ${data.error.info}`);
                }

                const searchResults = data.query?.search;
                
                let resultHtml;

                if (searchResults && searchResults.length > 0) {
                    const result = searchResults[0]; 
                    
                    // --- STEP 1: SMART MEDICAL FILTER (Less strict for high-relevance terms) ---
                    if (!isMedicalTopic(result.title, searchTerm)) {
                         resultHtml = `
                            <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Topic Blocked</p>
                            <p class="font-bold text-lg text-red-700 mb-2">Non-Medical Query Detected</p>
                            <p class="text-gray-700">The query **"${originalQuery}"** did not return a strongly medical or health-related Wikipedia article (found: "${result.title}").</p>
                            <p class="text-gray-700 mt-2">This Health Assistant is restricted to providing information only on medical and health topics.</p>
                        `;
                    } else {
                        // --- STEP 2: DISPLAY VALID MEDICAL RESULT ---
                        const snippetHtml = cleanSnippet(result.snippet);
                        const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(result.title.replace(/ /g, '_'))}`;

                        resultHtml = `
                            <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Disclaimer: I am a fact-finding assistant, not a doctor.</p>
                            <h4 class="font-bold text-lg text-blue-700 mb-2">Wikipedia Result for "${result.title}"</h4>
                            <p class="text-gray-700 leading-relaxed">${snippetHtml}</p>
                            <p class="mt-3 text-xs">Source: <a href="${wikiUrl}" target="_blank" class="text-teal-600 hover:underline">${wikiUrl}</a></p>
                        `;
                    }
                } else {
                    // --- STEP 3: NO RESULT FOUND ---
                    resultHtml = `
                        <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Disclaimer: I am a fact-finding assistant, not a doctor.</p>
                        <p class="font-bold text-lg text-blue-700 mb-2">No Wikipedia Result</p>
                        <p class="text-gray-700">No specific health article found for your query: **"${originalQuery}"**. Please try a different term or simplify your question.</p>
                    `;
                }
                
                // Replace loading bubble content with results
                loadingBubble.innerHTML = resultHtml;

            } catch (error) {
                console.error('Wikipedia API Error:', error);
                
                // Replace loading bubble content with error message
                loadingBubble.innerHTML = `
                    <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">System Error</p>
                    <p class="text-red-700">An unexpected error occurred while connecting to the source. Check the console for details.</p>
                `;
            } finally {
                // Re-enable input
                searchInput.disabled = false;
                document.getElementById('searchButton').disabled = false;
                searchInput.focus();
                scrollToBottom();
            }
        }
    </script>
</body>
</html>
