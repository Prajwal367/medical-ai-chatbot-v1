<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .app-layout { display: flex; flex-direction: column; min-height: 100vh; height: 100vh; overflow-y: hidden; }
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 1.5rem; max-width: 1000px; width: 100%; margin: 0 auto; }
        .user-bubble { background-color: #3b82f6; color: white; border-radius: 1rem 0.5rem 0.5rem 1rem; max-width: 60%; margin-left: auto; }
        .assistant-bubble { background-color: #eff6ff; color: #1f2937; border-radius: 0.5rem 1rem 1rem 0.5rem; max-width: 75%; margin-right: auto; border: 1px solid #bfdbfe; }
        header, #input-footer { flex-shrink: 0; }
    </style>
</head>
<body class="bg-gray-100 app-layout">
    <!-- Header -->
    <header class="bg-blue-800 text-white p-4 shadow-md flex justify-center sticky top-0 z-10">
        <div class="w-full max-w-4xl flex justify-between items-center">
            <h1 class="text-xl font-bold">HEALTH ASSISTANT</h1>
            <span class="text-sm font-medium opacity-80">Fact Finder Project</span>
        </div>
    </header>
    <!-- Warning Disclaimer -->
    <div class="bg-yellow-100 text-yellow-800 text-sm font-medium p-3 flex justify-center w-full shadow-inner sticky top-16 z-10">
        <div class="w-full max-w-4xl">
            <strong class="uppercase mr-2">Mandatory Warning:</strong> This tool uses Wikipedia and is for informational purposes only. It is **NOT** a substitute for professional medical advice, diagnosis, or treatment. Always consult a qualified doctor.
        </div>
    </div>
    <!-- Chat Window -->
    <div id="chat-window" class="space-y-6 pt-6 pb-6">
        <div class="flex justify-start">
            <div class="assistant-bubble p-4 shadow-lg">
                <p class="font-bold text-lg text-blue-800 mb-2">Hello! I am a **Wikipedia Health Assistant**.</p>
                <p>I can provide quick, sourced summaries from Wikipedia. ***What health topic would you like to search for?***</p>
                <p class="text-xs mt-2 text-gray-500">Please start by asking a general health question (e.g., "seasonal allergies," "benefits of walking," or "what is an aneurysm?").</p>
            </div>
        </div>
    </div>
    <!-- Input Footer -->
    <div id="input-footer" class="bg-white p-4 border-t border-gray-200 sticky bottom-0 z-20 flex justify-center w-full">
        <div class="w-full max-w-4xl flex gap-3">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search for a health topic..." 
                class="flex-grow p-3 border-2 border-gray-300 rounded-full focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-base shadow-inner"
                onkeydown="if(event.key === 'Enter') handleUserInput()"
            >
            <button 
                id="searchButton" 
                onclick="handleUserInput()" 
                class="bg-blue-600 text-white w-12 h-12 rounded-full font-bold hover:bg-blue-700 transition duration-200 shadow-xl active:scale-95 transform flex items-center justify-center"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" transform="rotate(90 12 12) translate(0 0) scale(-1 1)" />
                </svg>
            </button>
        </div>
    </div>
    <script>
        // --- CONFIGURATION & UTILS (unchanged) ---
        const WIKI_USER_AGENT = 'HealthAssistantApp/1.8 (user-provided-email.com)'; 
        const WIKI_API_URL = 'https://en.wikipedia.org/w/api.php';
        const chatWindow = document.getElementById('chat-window');
        const searchInput = document.getElementById('searchInput');
        const GREETINGS = ['hi', 'hello', 'hey', 'good morning', 'good afternoon'];
        const MAX_SUMMARY_LENGTH = 350; 
        const MEDICAL_KEYWORDS = [
            'disease', 'syndrome', 'disorder', 'condition', 'treatment', 'therapy', 'drug',
            'medicine', 'anatomy', 'physiology', 'surgery', 'virus', 'bacteria', 'fungus',
            'medical', 'health', 'symptom', 'pain', 'cold', 'flu', 
            'diabetes', 'complication', 'nutrition', 'vaccine', 'virus',
            'heart', 'kidney', 'lung', 'infection', 'inflammation',
            'fever', 'cough', 'cancer', 'headache', 'allergy', 'aneurysm', 'migraine', 
            'asthma', 'insomnia', 'anxiety', 'depression', 'hypertension', 'stroke',
            'dermatology', 'cardiology', 'gastroenterology', 'neurology', 'pediatrics'
        ];
        function scrollToBottom() { setTimeout(() => { chatWindow.scrollTop = chatWindow.scrollHeight; }, 50); }
        function addMessage(content, type) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `${type === 'user' ? 'user-bubble' : 'assistant-bubble'} p-4 shadow-md`;
            bubble.innerHTML = content;
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            scrollToBottom();
            return bubble;
        }
        function handleGreeting(query) {
            const normalizedQuery = query.toLowerCase();
            const isGreeting = GREETINGS.some(greeting => 
                normalizedQuery === greeting || normalizedQuery.startsWith(greeting + ' ')
            );
            if (isGreeting) {
                const response = `
                    <p class="font-bold text-lg text-blue-800 mb-2">Hello! How can I assist you with your health query today?</p>
                    <p class="text-gray-700 leading-relaxed">Remember, I use Wikipedia for information. For example, try asking: "What are the common symptoms of influenza?"</p>
                `;
                addMessage(response, 'assistant');
                return true;
            }
            return false;
        }
        function extractSearchTerm(query) {
            let lowerQuery = query.toLowerCase().trim();
            lowerQuery = lowerQuery
                .replace(/^(what are the common symptoms of|what is|tell me about|i have|what causes|how do i treat|symptoms of|causes of|how to treat)\s+/i, '')
                .replace(/[?,.!'"]+/g, '');
            return lowerQuery.trim();
        }
        function isMedicalTopic(title, cleanedQuery) {
            const normalizedTitle = title.toLowerCase();
            const normalizedCleanedQuery = cleanedQuery.toLowerCase();
            const titleContainsMedicalKeyword = MEDICAL_KEYWORDS.some(keyword => normalizedTitle.includes(keyword.toLowerCase()));
            const isBasicMedicalTerm = MEDICAL_KEYWORDS.includes(normalizedCleanedQuery);
            const titleContainsQuery = normalizedTitle.includes(normalizedCleanedQuery);
            // Prevent irrelevant results, like medical centers
            const blockWords = ["center", "disambiguation"];
            if (blockWords.some(block => normalizedTitle.includes(block))) return false;
            return titleContainsQuery || titleContainsMedicalKeyword || isBasicMedicalTerm;
        }
        function createSimpleSummary(extract) {
            let plainText = extract.replace(/<[^>]*>/g, '').replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
            plainText = plainText
                .replace(/\(.*?\)/g, '')
                .replace(/^(is a symptom of|is a condition where|is a type of|is an inflammatory process|also known as)/i, '')
                .trim();
            if (plainText.length > MAX_SUMMARY_LENGTH) {
                let truncated = plainText.substring(0, MAX_SUMMARY_LENGTH);
                let lastPunctuation = Math.max(truncated.lastIndexOf('.'), truncated.lastIndexOf('?'), truncated.lastIndexOf('!'));
                if (lastPunctuation !== -1 && lastPunctuation > MAX_SUMMARY_LENGTH * 0.8) {
                    plainText = truncated.substring(0, lastPunctuation + 1);
                } else {
                    let lastSpace = truncated.lastIndexOf(' ');
                    plainText = (lastSpace !== -1 ? truncated.substring(0, lastSpace) : truncated) + '...';
                }
            }
            if (plainText.length > 0) {
                plainText = plainText.charAt(0).toUpperCase() + plainText.slice(1);
            }
            return plainText;
        }

        // ------------ MAIN LOGIC CHANGE (only the searchWikipedia function) -------------
        async function searchWikipedia(originalQuery, searchTerm) {
            const loadingHtml = `
                <div class="flex items-center space-x-2 text-gray-500">
                    <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Searching Wikipedia for <strong>${searchTerm}</strong>...</span>
                </div>
            `;
            const loadingBubble = addMessage(loadingHtml, 'assistant');
            try {
                // 1. Try exact title match first
                let titleParams = new URLSearchParams({
                    action: 'query',
                    prop: 'extracts',
                    titles: searchTerm,
                    exintro: true,
                    explaintext: true,
                    format: 'json',
                    origin: '*'
                });
                let titleUrl = `${WIKI_API_URL}?${titleParams.toString()}`;
                let titleResponse = await fetch(titleUrl, {
                    method: 'GET',
                    headers: { 'Api-User-Agent': WIKI_USER_AGENT }
                });
                let titleData = await titleResponse.json();
                let pages = titleData.query.pages;
                let pageKey = Object.keys(pages)[0];
                let directExtract = pages[pageKey]?.extract;
                let directTitle = pages[pageKey]?.title;

                if (directExtract && isMedicalTopic(directTitle || '', searchTerm)) {
                    const simpleSummary = createSimpleSummary(directExtract);
                    const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(directTitle.replace(/ /g, '_'))}`;
                    loadingBubble.innerHTML = `
                        <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Disclaimer: I am a fact-finding assistant, not a doctor.</p>
                        <h4 class="font-bold text-lg text-blue-700 mb-2">Quick Summary for "${directTitle}"</h4>
                        <p class="text-gray-800 leading-relaxed font-medium">${simpleSummary}</p>
                        <p class="mt-3 text-xs">Source: <a href="${wikiUrl}" target="_blank" class="text-teal-600 hover:underline">Read the full Wikipedia article for more detail</a></p>
                    `;
                    return;
                }

                // 2. Fallback to Wikipedia search API if no exact match
                const searchParams = new URLSearchParams({
                    action: 'query',
                    list: 'search',
                    srsearch: `"${searchTerm}" category:Medicine OR category:Health`,
                    srlimit: 2,
                    format: 'json',
                    origin: '*'
                });
                const searchUrl = `${WIKI_API_URL}?${searchParams.toString()}`;
                let searchResponse = await fetch(searchUrl, {
                    method: 'GET',
                    headers: { 'Api-User-Agent': WIKI_USER_AGENT }
                });
                let searchData = await searchResponse.json();
                const searchResults = searchData.query?.search;

                let foundResult = null;
                if (searchResults && searchResults.length > 0) {
                    foundResult = searchResults.find(r => isMedicalTopic(r.title, searchTerm));
                }
                if (foundResult) {
                    const extractParams = new URLSearchParams({
                        action: 'query',
                        prop: 'extracts',
                        titles: foundResult.title,
                        exintro: true,
                        explaintext: true,
                        format: 'json',
                        origin: '*'
                    });
                    const extractUrl = `${WIKI_API_URL}?${extractParams.toString()}`;
                    let extractResponse = await fetch(extractUrl, {
                        method: 'GET',
                        headers: { 'Api-User-Agent': WIKI_USER_AGENT }
                    });
                    let extractData = await extractResponse.json();
                    const pages = extractData.query.pages;
                    const pageId = Object.keys(pages)[0];
                    const extract = pages[pageId]?.extract;
                    const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(foundResult.title.replace(/ /g, '_'))}`;
                    if (extract) {
                        const simpleSummary = createSimpleSummary(extract);
                        loadingBubble.innerHTML = `
                            <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Disclaimer: I am a fact-finding assistant, not a doctor.</p>
                            <h4 class="font-bold text-lg text-blue-700 mb-2">Quick Summary for "${foundResult.title}"</h4>
                            <p class="text-gray-800 leading-relaxed font-medium">${simpleSummary}</p>
                            <p class="mt-3 text-xs">Source: <a href="${wikiUrl}" target="_blank" class="text-teal-600 hover:underline">Read the full Wikipedia article for more detail</a></p>
                        `;
                    } else {
                        loadingBubble.innerHTML = `
                            <p class="font-bold text-lg text-red-700 mb-2">Could Not Load Article Details</p>
                            <p class="text-gray-700">We found the article: <strong>${foundResult.title}</strong>, but could not retrieve its text summary.</p>
                            <p class="mt-3 text-xs">Source: <a href="${wikiUrl}" target="_blank" class="text-teal-600 hover:underline">View Article</a></p>
                        `;
                    }
                } else {
                    loadingBubble.innerHTML = `
                        <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">Disclaimer: I am a fact-finding assistant, not a doctor.</p>
                        <p class="font-bold text-lg text-blue-700 mb-2">No Wikipedia Result</p>
                        <p class="text-gray-700">No specific health article found for your query: <strong>${originalQuery}</strong>. Please try a different term or simplify your question.</p>
                    `;
                }
            } catch (error) {
                console.error('Wikipedia API Error:', error);
                loadingBubble.innerHTML = `
                    <p class="text-sm font-semibold text-red-500 border-b border-red-200 pb-2 mb-2">System Error</p>
                    <p class="text-red-700">An unexpected error occurred while searching Wikipedia. Please try again.</p>
                `;
            } finally {
                searchInput.disabled = false;
                document.getElementById('searchButton').disabled = false;
                searchInput.focus();
                scrollToBottom();
            }
        }

        // ---------------- REST OF YOUR CODE IS UNCHANGED -----------------
        function handleUserInput() {
            const query = searchInput.value.trim();
            if (!query) return;
            addMessage(query, 'user');
            searchInput.value = '';
            searchInput.disabled = true;
            document.getElementById('searchButton').disabled = true;
            if (handleGreeting(query)) {
                searchInput.disabled = false;
                document.getElementById('searchButton').disabled = false;
                searchInput.focus();
                return;
            }
            const searchTerm = extractSearchTerm(query);
            searchWikipedia(query, searchTerm);
        }
    </script>
</body>
</html>
