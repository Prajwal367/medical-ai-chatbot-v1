<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikipedia Health Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set the overall document background and font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Clean white background for full canvas */
        }
        /* Custom scrollbar for the chat history */
        .chat-history::-webkit-scrollbar {
            width: 8px;
        }
        .chat-history::-webkit-scrollbar-thumb {
            background-color: #93c5fd; /* Soft blue scrollbar */
            border-radius: 4px;
        }
        .chat-history::-webkit-scrollbar-track {
            background: #f1f5f9; /* Light track */
        }
        /* Style for the user message bubble */
        .user-message {
            background-color: #2563eb; /* Strong Blue for user */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px; /* More modern, slightly less aggressive corner */
        }
        /* Style for the assistant message bubble */
        .assistant-message {
            background-color: #e0f2fe; /* Very light blue for contrast and comfort */
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #bfdbfe; /* Subtle light blue border */
        }
        /* Ensure the body and html take up full height of the viewport */
        html, body, #chat-container {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- Chat Container: w-full and h-full ensures it fills the available space -->
    <div id="chat-container" class="flex-grow flex flex-col bg-white overflow-hidden max-w-full mx-auto shadow-xl">

        <!-- Header: Deep Navy Blue -->
        <header class="p-4 bg-blue-900 text-white shadow-lg flex items-center justify-between">
            <h1 class="text-xl font-extrabold tracking-tight flex items-center gap-3">
                <!-- Lucide Stethoscope Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-stethoscope"><path d="M11.3 5c.5-2.2 2.4-3.9 4.9-3.9 2.5 0 4.4 1.7 4.9 3.9"/><path d="M14 11l-3 3-2 2h4l2-2 3-3"/><path d="M14 11V3"/><path d="M14 11h-4c-1.3 0-2.5.5-3.4 1.4L4.8 14.2"/><path d="M4.8 14.2c-.8.8-1.4 2-1.4 3.4 0 2.8 2.2 5 5 5s5-2.2 5-5c0-1.3-.5-2.5-1.4-3.4L9 11"/></svg>
                Wikipedia Health Assistant
            </h1>
        </header>

        <!-- Chat History: Added light background -->
        <div id="chat-history" class="chat-history flex-grow p-4 overflow-y-auto space-y-4 bg-gray-50">
            <!-- Welcome Message -->
            <div class="assistant-message max-w-xs md:max-w-md p-3 rounded-xl shadow">
                <p>Hello! I'm your **Wikipedia Health Assistant**. I can look up information on medical conditions, symptoms, and diseases for educational purposes.</p>
                <p class="mt-2 text-xs text-blue-800 font-semibold">‚ö†Ô∏è Always consult a healthcare professional for diagnosis or treatment. This is not medical advice.</p>
            </div>
        </div>

        <!-- Input Form and Loading Indicator -->
        <footer class="p-4 border-t border-gray-200 bg-white">
            <form id="chat-form" class="flex gap-3">
                <input
                    type="text"
                    id="user-input"
                    class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner"
                    placeholder="Ask about a medical condition (e.g., 'fever' or 'what is pneumonia')"
                    required
                />
                <button
                    type="submit"
                    id="submit-button"
                    class="px-5 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition duration-150 shadow-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="button-text">Send</span>
                    <div id="loading-spinner" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </form>
        </footer>
    </div>

    <!-- JavaScript for Chat Functionality (ADDED ERROR LOGGING) -->
    <script>
        const chatForm = document.getElementById('chat-form');
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- API CONFIGURATION ---
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const apiKey = ""; // Leave as empty string for Canvas to provide the key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // System Instruction to guide the model's behavior and grounding query
        const systemInstruction = "You are a Wikipedia Health Assistant. Your task is to look up the user's medical query on Wikipedia, summarize the findings concisely, and state that the information is for educational purposes only. You MUST use Google Search to find a relevant Wikipedia article first, then summarize that content. The final answer must be a concise, easy-to-read summary, followed by a citation.";
        // --- END API CONFIGURATION ---


        // Function to create and append a message bubble
        function appendMessage(sender, text, sourceUrl = null) {
            const messageDiv = document.createElement('div');
            // Use flex-shrink-0 to ensure the message bubble doesn't get squished
            messageDiv.className = `max-w-xs md:max-w-md p-3 rounded-xl shadow break-words flex flex-col flex-shrink-0 ${sender === 'user' ? 'user-message self-end' : 'assistant-message self-start'}`;
            
            // Adjusting borderRadius for a softer look
            messageDiv.style.borderRadius = sender === 'user' ? '12px 12px 4px 12px' : '12px 12px 12px 4px';
            
            let content = text;
            const paragraph = document.createElement('p');
            paragraph.textContent = content; 
            messageDiv.appendChild(paragraph);

            if (sourceUrl) {
                const link = document.createElement('a');
                link.href = sourceUrl;
                link.target = '_blank';
                link.className = 'mt-2 text-xs font-medium transition duration-150 underline';
                if (sender === 'assistant') {
                    // Adjust link color for assistant bubble's lighter background
                    link.className += ' text-blue-700 hover:text-blue-900';
                } else {
                    link.className += ' text-blue-100 hover:text-white';
                }
                link.textContent = 'View Full Article on Wikipedia';
                messageDiv.appendChild(link);
            }

            chatHistory.appendChild(messageDiv);
            
            // Scroll to the bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Exponential backoff retry function
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        // Log the non-successful HTTP status
                        console.error('API Call Status Error:', response.status, response.statusText);
                        const errorText = await response.text();
                        console.error('API Error Response Body:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Handle form submission
        chatForm.addEventListener('submit', handleSubmit);

        async function handleSubmit(e) {
            e.preventDefault();
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // 1. Display user message
            appendMessage('user', prompt);
            userInput.value = '';

            // 2. Show loading state
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            try {
                // Construct the prompt for the model
                const userQuery = `Search Wikipedia for '${prompt}' and provide a concise summary of the medical/health information found.`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    // Enable Google Search grounding
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };
                
                // IMPORTANT: Log the full API URL being used
                console.log("Attempting API call to:", apiUrl.replace(`?key=${apiKey}`, '...'));

                // 3. Fetch response from Gemini API directly
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 4. Parse JSON response
                const result = await response.json();

                const candidate = result.candidates?.[0];
                let assistantResponseText = '‚ö†Ô∏è I could not process your query. The response structure was unexpected.';
                let sourceUrl = null;

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    assistantResponseText = candidate.content.parts[0].text;
                    
                    // Extract grounding sources (citations)
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        // Look for a source that is likely from Wikipedia
                        const wikipediaSource = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .find(source => source.uri && source.uri.includes('wikipedia.org'));
                        
                        if (wikipediaSource) {
                            sourceUrl = wikipediaSource.uri;
                        }
                    }
                }

                // 5. Display assistant message
                appendMessage('assistant', assistantResponseText, sourceUrl);

            } catch (error) {
                // --- CRITICAL DEBUGGING SECTION ---
                console.error('--- FATAL ERROR DURING API CALL ---');
                console.error('Check the Network tab in your browser console for details on the failed request.');
                console.error('Full Error Object:', error);
                // ------------------------------------

                // Display a clear error message to the user
                appendMessage('assistant', 'üö® Network/API Error: The connection failed. Please check the Developer Console for details on the error (F12 or Inspect > Console).');
            } finally {
                // 6. Reset loading state
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
